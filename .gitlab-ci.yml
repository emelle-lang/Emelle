image: ocaml/opam2:4.08

variables:
  GIT_SUBMODULE_STRATEGY: recursive

before_script:
- opam switch
- opam depext conf-m4
- opam install -y -q odoc
- opam install -y -q . --deps-only
- opam install -y -q ./bexp --deps-only

build:
  stage: build
  script:
  - dune build app/main.exe --profile release
  - dune build editor/main.bc.js --profile release
  - dune build editor/index.html
  - dune build editor/stylesheet.css
  - dune build try/main.bc.js --profile release
  - dune build try/stylesheet.css
  - dune build try/index.html
  artifacts:
    paths:
    - _build

test:
  stage: test
  script:
  - dune runtest

pages:
  stage: deploy
  script:
  - dune build @doc
  - mkdir public
  - mv _build/main/_doc/_html public/doc
  - mv _build/main/editor public/editor
  - mv _build/main/try public/try
  artifacts:
    paths:
    - public
  only:
  - master
